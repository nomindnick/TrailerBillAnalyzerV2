<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bill Analysis Report - {{ bill_info.bill_number }}</title>
    <style>
        /* Additional styles are inlined dynamically from report_generator.py */
    </style>
</head>
<body>
    <!-- Report Header -->
    <div class="report-header">
        <h1>Bill Analysis Report</h1>
        <p><strong>Bill Number:</strong> {{ bill_info.bill_number }}</p>
        <p><strong>Chapter Number:</strong> {{ bill_info.chapter_number }}</p>
        <p><strong>Title:</strong> {{ bill_info.title }}</p>
        <p><strong>Date Approved:</strong> {{ date_approved }}</p>
    </div>

    <!-- Executive Summary -->
    <div class="executive-summary">
        <h2>Executive Summary</h2>
        <p><strong>Total Changes Identified:</strong> {{ total_changes }}</p>
        <p><strong>Local Agency Impact:</strong> {{ local_summary }}</p>
        <p><strong>State Agency Impact:</strong> {{ state_summary }}</p>
        <p><strong>Practice Areas Affected (Primary Relevance):</strong>
            {% if practice_areas %}
                {{ practice_areas|join(', ') }}
            {% else %}
                None
            {% endif %}
        </p>
    </div>

    <!-- Sections by Practice Group or No Local Impact -->
    {% for section in report_sections %}
    <div class="report-section">
        <h2 class="report-section-title">{{ section.title }}</h2>

        {% for change in section.content.changes %}
        <div class="change-box">
            <div class="change-header">
                Substantive Change
            </div>

            <!-- Show the Bill Sections with full text -->
            <div class="section-list">
                <strong>Trailer Bill Sections:</strong>
                {% if change.bill_section_details and change.bill_section_details|length > 0 %}
                    {% for sec in change.bill_section_details %}
                        <div class="section-item">
                            <strong>{{ sec.original_label }}</strong><br>
                            {{ sec.text }}
                        </div>
                    {% endfor %}
                {% else %}
                    <span>No specific sections found. 
                    {% if change.bill_sections %}
                        (Referenced sections: {{ change.bill_sections|join(', ') }} could not be matched)
                    {% endif %}
                    </span>
                {% endif %}
            </div>

            <!-- AI-generated summary per instructions (1) (2) (3) -->
            <p><strong>Summary:</strong><br>
               {{ change.substantive_change }}
            </p>

            <!-- Local agencies impacted: explicit heading -->
            <h4>Local Agencies Impacted</h4>
            {% if change.local_agencies_impacted and change.local_agencies_impacted|length > 0 %}
                <ul>
                {% for agency in change.local_agencies_impacted %}
                    <li>{{ agency }}</li>
                {% endfor %}
                </ul>
            {% else %}
                <p>No local agencies identified.</p>
            {% endif %}

            <!-- Impact Description -->
            <p><strong>Impact Description:</strong><br>
               {{ change.local_agency_impact }}
            </p>

            {% if change.key_action_items %}
            <div class="action-items">
                <strong>Key Action Items</strong>
                <ul>
                    {% for item in change.key_action_items %}
                    <li>{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if change.deadlines %}
            <div class="action-items">
                <strong>Deadlines</strong>
                <ul>
                    {% for dl in change.deadlines %}
                    <li>
                        <strong>{{ dl.date if dl.date else "N/A" }}</strong>:
                        {{ dl.description }}
                        {% if dl.affected_agencies %}
                        (Affected agencies: {{ dl.affected_agencies|join(', ') }})
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if change.requirements %}
            <div class="action-items">
                <strong>Additional Requirements</strong>
                <ul>
                    {% for req in change.requirements %}
                    <li>{{ req }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if change.practice_groups %}
            <div class="action-items">
                <strong>Relevant Practice Groups</strong>
                <ul>
                    {% for pg in change.practice_groups %}
                    <li>
                        {{ pg.name }} ({{ pg.relevance }})
                        {% if pg.justification %}
                          - {{ pg.justification }}
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</body>
</html>
