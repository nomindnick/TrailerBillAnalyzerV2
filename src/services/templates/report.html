<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bill Analysis Report - {{ bill_info.bill_number }}</title>
    <style>
        /* Additional styles are inlined dynamically from report_generator.py */
    </style>
</head>
<body>
    <!-- Report Header -->
    <div class="report-header">
        <h1>Bill Analysis Report</h1>
        <p><strong>Bill Number:</strong> {{ bill_info.bill_number }}</p>
        <p><strong>Chapter Number:</strong> {{ bill_info.chapter_number }}</p>
        <p><strong>Title:</strong> {{ bill_info.title }}</p>
        <p><strong>Date Approved:</strong> {{ date_approved }}</p>
    </div>

    <!-- Executive Summary -->
    <div class="executive-summary">
        <h2>Executive Summary</h2>
        <p><strong>Total Changes:</strong> {{ total_changes }}</p>
        <p><strong>Changes Impacting Local Agencies:</strong> {{ impacting_changes }}</p>
        <p><strong>Practice Areas Affected:</strong>
            {% if practice_areas %}
                {{ practice_areas|join(', ') }}
            {% else %}
                None
            {% endif %}
        </p>
    </div>

    <!-- Report by Practice Group -->
    <h2>Report by Practice Group</h2>
    {% if grouped_changes %}
      {% for group_name, changes_list in grouped_changes.items() %}
        <div class="practice-group-section">
            <h3>{{ group_name }}</h3>
            {% for change in changes_list %}
            <div class="change-box">
                <div class="change-header">
                    <strong>Substantive Change</strong>
                </div>

                <!-- Show the Bill Section references -->
                <div class="section-list">
                    <strong>Trailer Bill Sections:</strong>
                    {% if change.section_details %}
                        {% for sec in change.section_details %}
                            <span class="section-item">
                                SEC. {{ sec.number }}
                                {% if sec.code_modifications %}
                                    {% for cmd in sec.code_modifications %}
                                        <br>{{ cmd.code_name }} Section {{ cmd.section }}
                                        {% if cmd.action %}[{{ cmd.action|capitalize }}]{% endif %}
                                    {% endfor %}
                                {% endif %}
                            </span>
                        {% endfor %}
                    {% else %}
                        <span>No specific sections found.</span>
                    {% endif %}
                </div>

                <p>{{ change.substantive_change }}</p>

                <!-- Show Existing Law / Proposed Changes -->
                {% if change.existing_law %}
                <h4>Existing Law</h4>
                <p>{{ change.existing_law }}</p>
                {% endif %}
                {% if change.proposed_change %}
                <h4>Proposed Changes</h4>
                <p>{{ change.proposed_change }}</p>
                {% endif %}

                <h4>Local Agencies Impacted</h4>
                {% if change.local_agency_impact and change.local_agency_impact != "No specific local agencies identified." %}
                    <p>{{ change.local_agency_impact }}</p>
                {% else %}
                    <p>No specific local agencies identified.</p>
                {% endif %}

                {% if change.key_action_items %}
                <div class="action-items">
                    <strong>Key Action Items</strong>
                    <ul>
                        {% for item in change.key_action_items %}
                        <li>{{ item }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if change.deadlines %}
                <div class="action-items">
                    <strong>Deadlines</strong>
                    <ul>
                        {% for dl in change.deadlines %}
                        <li>
                            <strong>{{ dl.date if dl.date else "N/A" }}</strong>:
                            {{ dl.description }}
                            {% if dl.affected_agencies %}
                            (Affected agencies: {{ dl.affected_agencies|join(', ') }})
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if change.requirements %}
                <div class="action-items">
                    <strong>Additional Requirements</strong>
                    <ul>
                        {% for req in change.requirements %}
                        <li>{{ req }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
      {% endfor %}
    {% else %}
      <p>No changes were matched to specific practice groups.</p>
    {% endif %}

    {% if general_local_agency_impact_changes %}
    <h2>General Local Agency Impact</h2>
    {% for change in general_local_agency_impact_changes %}
    <div class="change-box">
        <div class="change-header">
            <strong>Substantive Change</strong>
        </div>

        <!-- Show the Bill Section references -->
        <div class="section-list">
            <strong>Trailer Bill Sections:</strong>
            {% if change.section_details %}
                {% for sec in change.section_details %}
                    <span class="section-item">
                        SEC. {{ sec.number }}
                        {% if sec.code_modifications %}
                            {% for cmd in sec.code_modifications %}
                                <br>{{ cmd.code_name }} Section {{ cmd.section }}
                                {% if cmd.action %}[{{ cmd.action|capitalize }}]{% endif %}
                            {% endfor %}
                        {% endif %}
                    </span>
                {% endfor %}
            {% else %}
                <span>No specific sections found.</span>
            {% endif %}
        </div>

        <p>{{ change.substantive_change }}</p>

        <!-- Show Existing Law / Proposed Changes -->
        {% if change.existing_law %}
        <h4>Existing Law</h4>
        <p>{{ change.existing_law }}</p>
        {% endif %}
        {% if change.proposed_change %}
        <h4>Proposed Changes</h4>
        <p>{{ change.proposed_change }}</p>
        {% endif %}

        <h4>Local Agencies Impacted</h4>
        {% if change.local_agency_impact and change.local_agency_impact != "No specific local agencies identified." %}
            <p>{{ change.local_agency_impact }}</p>
        {% else %}
            <p>No specific local agencies identified.</p>
        {% endif %}

        {% if change.key_action_items %}
        <div class="action-items">
            <strong>Key Action Items</strong>
            <ul>
                {% for item in change.key_action_items %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if change.deadlines %}
        <div class="action-items">
            <strong>Deadlines</strong>
            <ul>
                {% for dl in change.deadlines %}
                <li>
                    <strong>{{ dl.date if dl.date else "N/A" }}</strong>:
                    {{ dl.description }}
                    {% if dl.affected_agencies %}
                    (Affected agencies: {{ dl.affected_agencies|join(', ') }})
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if change.requirements %}
        <div class="action-items">
            <strong>Additional Requirements</strong>
            <ul>
                {% for req in change.requirements %}
                <li>{{ req }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endfor %}
    {% endif %}

    {% if no_impact_changes %}
    <div class="no-impact-section">
        <h2>Changes with No Local Agency Impact</h2>
        {% for change in no_impact_changes %}
        <div class="change-box">
            <div class="change-header">
                <strong>Substantive Change</strong>
            </div>

            <div class="section-list">
                <strong>Trailer Bill Sections:</strong>
                {% if change.section_details %}
                    {% for sec in change.section_details %}
                        <span class="section-item">
                            SEC. {{ sec.number }}
                            {% if sec.code_modifications %}
                                {% for cmd in sec.code_modifications %}
                                    <br>{{ cmd.code_name }} Section {{ cmd.section }}
                                    {% if cmd.action %}[{{ cmd.action|capitalize }}]{% endif %}
                                {% endfor %}
                            {% endif %}
                        </span>
                    {% endfor %}
                {% else %}
                    <span>No specific sections found.</span>
                {% endif %}
            </div>

            <p>{{ change.substantive_change }}</p>

            <!-- Existing Law / Proposed Changes -->
            {% if change.existing_law %}
            <h4>Existing Law</h4>
            <p>{{ change.existing_law }}</p>
            {% endif %}
            {% if change.proposed_change %}
            <h4>Proposed Changes</h4>
            <p>{{ change.proposed_change }}</p>
            {% endif %}

            <h4>Local Agencies Impacted</h4>
            {% if change.local_agency_impact and change.local_agency_impact != "No specific local agencies identified." %}
                <p>{{ change.local_agency_impact }}</p>
            {% else %}
                <p>No specific local agencies identified.</p>
            {% endif %}

            {% if change.key_action_items %}
            <div class="action-items">
                <strong>Key Action Items</strong>
                <ul>
                    {% for item in change.key_action_items %}
                    <li>{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if change.deadlines %}
            <div class="action-items">
                <strong>Deadlines</strong>
                <ul>
                    {% for dl in change.deadlines %}
                    <li>
                        <strong>{{ dl.date if dl.date else "N/A" }}</strong>:
                        {{ dl.description }}
                        {% if dl.affected_agencies %}
                        (Affected agencies: {{ dl.affected_agencies|join(', ') }})
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if change.requirements %}
            <div class="action-items">
                <strong>Additional Requirements</strong>
                <ul>
                    {% for req in change.requirements %}
                    <li>{{ req }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</body>
</html>
